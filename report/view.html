<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Report | Proteomorphic</title>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/components.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
    <style>
        .report-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .report-header {
            text-align: center;
            margin-bottom: var(--spacing-3xl);
            padding-bottom: var(--spacing-xl);
            border-bottom: 1px solid var(--border-subtle);
        }

        .report-section {
            margin-bottom: var(--spacing-3xl);
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            padding-left: var(--spacing-md);
            border-left: 4px solid var(--accent-primary);
        }

        .risk-meter {
            height: 32px;
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: visible;
            position: relative;
        }

        .risk-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-success), var(--accent-warning), var(--accent-danger));
            width: 0%;
            transition: width 1s ease-out;
            border-radius: 16px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .risk-indicator {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--text-primary);
            z-index: 2;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
        }

        .info-item {
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        #protein-viewer {
            width: 100%;
            height: 400px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            position: relative;
        }

        @media print {

            .navbar,
            .btn {
                display: none;
            }

            .report-container {
                width: 100%;
                max-width: none;
                padding: 0;
            }

            .card {
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container flex justify-between items-center">
            <a href="../index.html" class="logo flex items-center gap-sm">
                <img src="../logo.png" alt="Proteomorphic" style="height: 32px; width: 32px; object-fit: contain;">
                <span>Proteomorphic</span>
            </a>
            <ul class="navbar-menu" style="margin-left: 2rem; margin-right: auto;">
                <li><a href="../knowledge.html" class="navbar-link">Knowledge Center</a></li>
            </ul>
            <div class="flex gap-sm">
                <button onclick="window.print()" class="btn btn-secondary btn-sm">Print</button>
                <button onclick="window.location.href='../dashboard/index.html'" class="btn btn-secondary btn-sm">Back
                    to Dashboard</button>
            </div>
        </div>
    </nav>

    <div class="report-container" id="reportContent">
        <!-- Header -->
        <div class="report-header">
            <h1 class="text-gradient">Proteomorphic</h1>
            <h2>Comprehensive Protein Misfolding Analysis Report</h2>
            <p class="text-secondary mt-md">Generated: <span id="reportDate">Loading...</span></p>
        </div>

        <!-- Executive Summary -->
        <section class="report-section">
            <h2 class="section-title">Executive Summary</h2>
            <div class="card mb-lg">
                <div class="info-grid">
                    <div class="info-item">
                        <p class="text-secondary mb-sm">Patient/Protein ID</p>
                        <strong id="reportId">Loading...</strong>
                    </div>
                    <div class="info-item">
                        <p class="text-secondary mb-sm">Analysis Date</p>
                        <strong id="analysisDate">Loading...</strong>
                    </div>
                    <div class="info-item">
                        <p class="text-secondary mb-sm">Protein Name</p>
                        <strong id="proteinName">Loading...</strong>
                    </div>
                    <div class="info-item">
                        <p class="text-secondary mb-sm">Organism</p>
                        <strong>Homo sapiens</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="mb-md">Overall Misfolding Risk Score</h3>
                <div class="risk-meter mb-md">
                    <div class="risk-fill" id="riskFill"></div>
                    <div class="risk-indicator" id="riskScore">Calculating...</div>
                </div>
                <div class="flex gap-md">
                    <span class="badge badge-secondary" id="riskLevel">Analyzing...</span>
                    <span class="badge badge-warning" style="display: none;">Urgent Clinical Review Recommended</span>
                </div>
                <div class="mt-lg">
                    <h4 class="mb-sm">Key Findings:</h4>
                    <ul class="findings-list" style="color: var(--text-secondary); line-height: 1.8;">
                        <li>Loading analysis data...</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Structural Analysis -->
        <section class="report-section">
            <h2 class="section-title">Structural Analysis Results</h2>
            <div class="card mb-lg">
                <h3 class="mb-md">3D Structure Visualization</h3>
                <div id="protein-viewer"></div>
                <p class="text-tertiary mt-sm" style="font-size: var(--font-size-sm); text-align: center;">
                    Interactive: Rotate with mouse, scroll to zoom
                </p>
            </div>

            <div class="card">
                <h3 class="mb-md">Misfolding Hotspots</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Residue Mutation</th>
                            <th>Position</th>
                            <th>Severity</th>
                            <th>Confidence</th>
                            <th>Impact</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Clinical Interpretation -->
        <section class="report-section">
            <h2 class="section-title">Clinical Interpretation</h2>
            <div class="card mb-lg">
                <h3 class="mb-md">Disease Association</h3>
                <div class="alert alert-secondary mb-md" id="diseaseAlert">
                    <strong>Status:</strong> Analyzing clinical data...
                </div>
                <p class="text-secondary mb-md" id="diseaseDescription">
                    Loading disease association data...
                </p>
                <h4 class="mb-sm">Pathogenicity Assessment:</h4>
                <ul style="color: var(--text-secondary); line-height: 1.8;" id="pathogenicityList">
                    <li>Loading...</li>
                </ul>
            </div>
        </section>

        <!-- CRISPR Intervention Protocol -->
        <section class="report-section crispr-section">
            <h2 class="section-title">CRISPR Intervention Protocol</h2>
            <div class="card mb-lg">
                <h3 class="mb-md">Guide RNA Design</h3>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>gRNA Sequence</th>
                                <th>Target Site</th>
                                <th>Efficiency</th>
                                <th>Off-Targets</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamic Content -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <div
            style="text-align: center; padding: var(--spacing-2xl) 0; border-top: 1px solid var(--border-subtle); margin-top: var(--spacing-3xl);">
            <p class="text-secondary" style="font-size: var(--font-size-sm);">
                This report was generated by Proteomorphic AI Analysis Platform<br>
                For research and clinical decision support purposes only<br>
                Â© 2025 Proteomorphic. All rights reserved.
            </p>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/report-data-loader.js?v=3"></script>
    <script>
        // Auth Check
        if (typeof Auth !== 'undefined') {
            Auth.requireAuth();
        }

        // Initialize 3D Viewer
        document.addEventListener('DOMContentLoaded', () => {
            const element = document.getElementById('protein-viewer');
            if (element && typeof $3Dmol !== 'undefined') {
                const config = { backgroundColor: 'white' };
                const viewer = $3Dmol.createViewer(element, config);

                // Load PDB (Expanded Map)
                const pdbMap = {
                    'app': '1AAP', 'amyloid': '1AAP', 'tau': '1JQJ', 'mapt': '1JQJ',
                    'synuclein': '1XQ8', 'snca': '1XQ8', 'parkin': '1BRP',
                    'huntingtin': '3IO4', 'htt': '3IO4', 'sod1': '1SPD',
                    'tdp-43': '4BS2', 'fus': '5W3N', 'cftr': '1XMI',
                    'hemoglobin': '1HHO', 'myoglobin': '1MBN', 'insulin': '1TRZ',
                    'bdnf': '1BND', 'ngf': '1BET', 'p53': '1TUP', 'brca': '1JM7'
                };

                // Get protein name from local storage to pick PDB
                let pdbId = '1AAP'; // Default
                try {
                    // Try to get from URL ID first
                    const urlParams = new URLSearchParams(window.location.search);
                    const analysisId = urlParams.get('id');
                    let data = {};

                    if (analysisId && typeof ProjectManager !== 'undefined') {
                        data = ProjectManager.getProject(analysisId) || {};
                    } else {
                        data = JSON.parse(localStorage.getItem('currentAnalysis') || '{}');
                    }

                    const pName = (data.proteinName || '').toLowerCase();

                    for (const key in pdbMap) {
                        if (pName.includes(key)) {
                            pdbId = pdbMap[key];
                            break;
                        }
                    }
                } catch (e) { console.error('Error getting PDB:', e); }

                $3Dmol.download(`pdb:${pdbId}`, viewer, { multimodel: true, frames: true }, function () {
                    viewer.setStyle({}, { cartoon: { color: 'spectrum' } });
                    viewer.zoomTo();
                    viewer.render();
                });
            }
        });
    </script>
</body>

</html>